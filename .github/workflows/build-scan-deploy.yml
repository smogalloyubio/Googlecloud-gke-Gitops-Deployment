name: Build, Scan, and Deploy to GKE

on:
  push:
    branches:
      - main
    paths:
      - 'bitcoinapp/**'
      - '.github/workflows/build-scan-deploy.yml'
  pull_request:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.AWS_ACCESS_KEY_ID}}
  GKE_CLUSTER_NAME: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  GKE_ZONE: ${{ secrets.AWS_REGION }}
  IMAGE_NAME: bitcoin-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
                       -t ${{ env.IMAGE_NAME }}:latest \
                       ./bitcoinapp

      - name: Save Docker image
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} | gzip > bitcoin-app-${{ env.IMAGE_TAG }}.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: bitcoin-app-${{ env.IMAGE_TAG }}.tar.gz

  scan-trivy:
    name: Scan with Trivy
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./bitcoinapp

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container-scan'

  scan-sonarqube:
    name: Scan with SonarQube
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./bitcoinapp
        run: npm install

      - name: Build application
        working-directory: ./bitcoinapp
        run: npm run build

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=bitcoin-app
            -Dsonar.sources=bitcoinapp/
            -Dsonar.exclusions=bitcoinapp/dist/**,bitcoinapp/node_modules/**

      - name: SonarQube Quality Gate
        id: sonarqube-quality-gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  deploy:
    name: Deploy to GKE
    needs: [build, scan-trivy, scan-sonarqube]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Get GKE cluster credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Get cluster node IPs
        id: nodes
        run: |
          NODE_IPS=$(kubectl get nodes -o jsonpath='{.items[*].status.addresses[?(@.type=="ExternalIP")].address}')
          if [ -z "$NODE_IPS" ]; then
            NODE_IPS=$(kubectl get nodes -o jsonpath='{.items[*].status.addresses[?(@.type=="InternalIP")].address}')
          fi
          echo "node_ips=$NODE_IPS" >> $GITHUB_OUTPUT
          echo "Cluster nodes: $NODE_IPS"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CLUSTER_SSH_KEY }}" > ~/.ssh/cluster_key
          chmod 600 ~/.ssh/cluster_key
          ssh-keyscan -H ${{ steps.nodes.outputs.node_ips }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Transfer image to cluster nodes
        run: |
          IMAGE_FILE="bitcoin-app-${{ env.IMAGE_TAG }}.tar.gz"
          SSH_USER="${{ secrets.CLUSTER_SSH_USER }}"
          
          for node_ip in ${{ steps.nodes.outputs.node_ips }}; do
            echo "Transferring image to node: $node_ip"
            scp -i ~/.ssh/cluster_key -o StrictHostKeyChecking=no \
              "$IMAGE_FILE" \
              "$SSH_USER@$node_ip:/tmp/$IMAGE_FILE"
            
            echo "Loading image on node: $node_ip"
            ssh -i ~/.ssh/cluster_key -o StrictHostKeyChecking=no \
              "$SSH_USER@$node_ip" \
              "docker load < /tmp/$IMAGE_FILE && rm /tmp/$IMAGE_FILE"
          done

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Create namespace
        run: |
          kubectl create namespace bitcoin-app --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install bitcoin-app ./helm/bitcoin-app \
            --namespace bitcoin-app \
            --set image.repository=${{ env.IMAGE_NAME }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set image.pullPolicy=Never \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/bitcoin-app -n bitcoin-app --timeout=5m
          kubectl get pods -n bitcoin-app

      - name: Get service details
        run: |
          kubectl get svc -n bitcoin-app
